name: Stem Splitting Test

on:
  workflow_dispatch:
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'cdmf_stem_splitting*.py'
      - 'static/scripts/cdmf_stem_splitting_ui.js'
      - 'test_stem_splitting_simple.sh'
      - 'requirements_ace_macos.txt'
      - 'audiotest.mp3'

permissions:
  contents: read

jobs:
  test-stem-splitting:
    name: Test Stem Splitting End-to-End
    runs-on: macos-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Display Python version
      run: python --version
      
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements_ace_macos.txt
        
    - name: Install Demucs
      run: |
        pip install demucs
        
    - name: Verify Demucs import
      run: |
        python -c "
        import demucs
        print('✓ Demucs imported successfully')
        import demucs.separate
        print('✓ demucs.separate module imported')
        "
        
    - name: Verify stem splitting module import
      run: |
        python -c "
        print('Testing cdmf_stem_splitting.py import...')
        from cdmf_stem_splitting import get_stem_splitter, StemSplitter
        print(f'✓ StemSplitter class imported successfully')
        splitter = get_stem_splitter()
        print(f'✓ get_stem_splitter() returned: {type(splitter)}')
        "
        
    - name: Verify test audio file exists
      run: |
        if [ ! -f "audiotest.mp3" ]; then
          echo "✗ Test audio file audiotest.mp3 not found"
          exit 1
        fi
        SIZE=$(stat -f%z audiotest.mp3 2>/dev/null || stat -c%s audiotest.mp3 2>/dev/null || echo "0")
        echo "✓ Test audio file found: audiotest.mp3 ($SIZE bytes)"
        if [ "$SIZE" -lt 1000 ]; then
          echo "✗ Test audio file seems too small"
          exit 1
        fi
        
    - name: Set Environment Variables
      run: |
        echo "PYTORCH_MPS_HIGH_WATERMARK_RATIO=0.0" >> $GITHUB_ENV
        echo "Set PYTORCH_MPS_HIGH_WATERMARK_RATIO=0.0"
        
    - name: Test stem splitting API (2-stem mode)
      run: |
        echo "Starting server in background..."
        python3 music_forge_ui.py > /tmp/stem_test.log 2>&1 &
        SERVER_PID=$!
        
        echo "Waiting for server to start..."
        for i in {1..30}; do
          if curl -s http://127.0.0.1:5056/ > /dev/null 2>&1; then
            echo "✓ Server ready"
            break
          fi
          if [ $i -eq 30 ]; then
            echo "✗ Server failed to start"
            kill $SERVER_PID 2>/dev/null || true
            cat /tmp/stem_test.log
            exit 1
          fi
          sleep 1
        done
        
        echo "Sending stem splitting request (2-stem mode)..."
        RESPONSE=$(curl -s -X POST http://127.0.0.1:5056/stem_split \
          -F "input_file=@audiotest.mp3" \
          -F "stem_count=2" \
          -F "device_preference=auto" \
          -F "export_format=wav" \
          -F "mode=" \
          -w "\nHTTP_CODE:%{http_code}")
        
        HTTP_CODE=$(echo "$RESPONSE" | grep "HTTP_CODE:" | cut -d: -f2)
        RESPONSE_BODY=$(echo "$RESPONSE" | sed '/HTTP_CODE:/d')
        
        echo "HTTP Response Code: $HTTP_CODE"
        
        if ! echo "$HTTP_CODE" | grep -qE "200|302"; then
          echo "✗ Stem splitting request failed (HTTP $HTTP_CODE)"
          echo "Response:"
          echo "$RESPONSE_BODY"
          echo ""
          echo "Server logs:"
          tail -50 /tmp/stem_test.log
          kill $SERVER_PID 2>/dev/null || true
          exit 1
        fi
        
        echo "✓ Stem splitting request accepted"
        
        # Monitor progress
        echo "Monitoring progress..."
        for i in {1..60}; do
          PROGRESS=$(curl -s http://127.0.0.1:5056/progress 2>/dev/null)
          DONE=$(echo "$PROGRESS" | grep -o '"done":[^,}]*' | cut -d: -f2 || echo "false")
          ERROR=$(echo "$PROGRESS" | grep -o '"error":[^,}]*' | cut -d: -f2 || echo "false")
          STAGE=$(echo "$PROGRESS" | grep -o '"stage":"[^"]*"' | cut -d'"' -f4 || echo "")
          
          if [ "$ERROR" = "true" ]; then
            echo "✗ Error detected in progress"
            echo "Progress: $PROGRESS"
            tail -50 /tmp/stem_test.log
            kill $SERVER_PID 2>/dev/null || true
            exit 1
          fi
          
          if [ "$DONE" = "true" ] && [ "$STAGE" = "stem_split_done" ]; then
            echo "✓ Stem splitting completed"
            break
          fi
          
          if [ $i -eq 60 ]; then
            echo "⚠ Timeout waiting for completion"
            tail -50 /tmp/stem_test.log
            kill $SERVER_PID 2>/dev/null || true
            exit 1
          fi
          
          sleep 2
        done
        
        kill $SERVER_PID 2>/dev/null || true
        
    - name: Verify output files were created
      run: |
        python -c "
        from pathlib import Path
        import sys
        
        # Check output directory
        output_dir = Path.home() / 'Library' / 'Application Support' / 'AceForge' / 'generated'
        if not output_dir.exists():
            output_dir = Path.home() / 'Library' / 'Application Support' / 'AceForge' / 'music'
        
        if not output_dir.exists():
            print('✗ Output directory does not exist')
            sys.exit(1)
        
        # Find stem_split directories
        stem_dirs = list(output_dir.glob('stem_split_*'))
        if not stem_dirs:
            print('✗ No stem_split_* directories found')
            sys.exit(1)
        
        # Check most recent stem_split directory
        latest_dir = max(stem_dirs, key=lambda p: p.stat().st_mtime)
        print(f'✓ Found stem output directory: {latest_dir.name}')
        
        # Look for model subdirectories (htdemucs, etc.)
        model_dirs = [d for d in latest_dir.iterdir() if d.is_dir()]
        if not model_dirs:
            print('✗ No model directories found in stem output')
            sys.exit(1)
        
        # Check for stem files in the model directory
        for model_dir in model_dirs:
            stem_files = list(model_dir.rglob('*.wav'))
            if stem_files:
                print(f'✓ Found {len(stem_files)} stem file(s) in {model_dir.name}')
                for stem_file in stem_files[:5]:  # Show first 5
                    size = stem_file.stat().st_size
                    print(f'  - {stem_file.name} ({size:,} bytes)')
                    if size == 0:
                        print(f'✗ File is empty')
                        sys.exit(1)
            else:
                print(f'⚠ No WAV files found in {model_dir.name}')
        
        print('✓ Stem splitting test successful - output files created')
        "
        
    - name: Upload test output as artifact
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: stem-splitting-test-output
        path: |
          ~/Library/Application Support/AceForge/generated/stem_split_*
          ~/Library/Application Support/AceForge/music/stem_split_*
        retention-days: 7
        if-no-files-found: ignore
